[id="QuarkusVaccinationQuickStart"]
= Vaccination appointment scheduler quickstart
ifdef::context[:parent-context: {context}]
:context: vaccination-quickstart

:OPTAPLANNER-COMM:
//Variable for the community version conditional statements.
//:OPTAPLANNER-ENT:
//Variable for the enterprise version conditional statements.

// Purpose statement for the assembly
[role="_abstract"]
You can use the OptaPlanner vaccination appointment scheduler quickstart to develop a vaccination schedule that is both efficient and fair. The vaccination appointment scheduler uses artificial intelligence (AI) to prioritize people and allocate time slots based on multiple constraints and priorities.

//.Prerequisites
//What are the prerequistites?


// tag::vaccination-scheduler-con[]
[id="vaccination-scheduler-con_{context}"]
== How the OptaPlanner vaccination appointment scheduler works

There are two main approaches to scheduling appointments. The system can either let a person choose an appointment slot (user-selects) or the system assigns a slot and tells the person when and where to attend (system-automatically-assigns). The OptaPlanner vaccination appointment scheduler users the system-automatically-assigns approach. With the OptaPlanner vaccination appointment scheduler, you can create a application where people provide their information to the system and the system assigns an appointment.

Characteristics of this approach:

* Appointment slots are allocated based on priority.
* The system allocates the best appointment time and location based on preconfigured planning constraints.
* The system is not overwhelmed by a large number of users competing for a limited number of appointments.

This approach solves the problem of vaccinating as many people as possible by using planning constraints to create a score for each person. The person’s score determines when they get an appointment. The higher the person’s score, the better chance they have of receiving an earlier appointment.

=== Constraints
Constraints are either hard, medium, or soft:

* Hard constraints cannot be broken. If any hard constraint is broken, the plan is unfeasible and cannot be executed:
** Capacity: Do not over-book vaccine capacity at any time at any location.
** Vaccine max age: If a vaccine has a maximum age, do not administer it to people who at the time of the first dose vaccination are older than the vaccine maximum age. Ensure people are given a vaccine type appropriate for their age. For example, don’t assign a 75 year old person an appointment for a vaccine that has a maximum age restriction of 65 years.
** Required vaccine type: Use the required vaccine type. For example, the second dose of a vaccine must be the same vaccine type as the first dose.
** Ready date: Administer the vaccine on or after the specified date. For example, if a person receives a second dose, do not administer it before the recommended earliest possible vaccination date for the specific vaccine type (such as 26 days after the first dose).
** Due date: Administer the vaccine on or before the specified date. For example, if a person receives a second dose, administer it before the recommended vaccination final due date for the specific vaccine (such as three months after the first dose).
** Restrict maximum travel distance: Assign each person to one of a group of  vaccination centers nearest to them. This is typically one of three centers. This restriction is calculated by travel time, not distance, so a person that lives in an urban area usually has a lower maximum distance to travel than a rural person.

* Medium constraints decide who does not get an appointment when there’s not enough capacity to assign appointments to everyone. This is called overconstrained planning:
** Schedule second dose vaccinations: Do not leave any second dose vaccination appointments unassigned unless the ideal date falls outside of the planning window.
** Schedule people based on their priority rating: Each person has a priority rating. This is typically their age but it can be much higher if they are, for example, a healthcare worker. Leave only people with the lowest priority ratings unassigned. They will be picked up in the next run. This constraint is softer than the previous constraint because the second dose is always prioritized over priority rating.
* Soft constraints should not be broken:
** Preferred vaccination center: If a person has a preferred vaccination center, give them an appointment at that center.
** Distance: Minimize the distance that a person must travel to their assigned vaccination center.
** Ideal date: Administer the vaccine on or as close to the specified date as possible. For example, if a person receives a second dose, administer it on the ideal date for the specific vaccine (such as 28 days after the first dose). This constraint is softer than the distance constraint to avoid sending people half-way across the country just to be one day closer to their ideal date.
** Priority rating: Schedule people with a higher priority rating earlier in the planning window. This constraint is softer than the distance constraint to avoid sending people half-way across the country. This constraint is also softer than the ideal date constraint because the second dose is prioritized over priority rating.

Hard constraints are weighted against other hard constraints. Soft constraints are weighted against other soft constraints. However, hard constraints always outweigh medium and soft constraints regardless of their respective weights.
Because you have more people than you have appointment slots, you need to make tough decisions. Second dose appointments are always assigned first to avoid creating a backlog that would overwhelm you later. After that, people are assigned based on their priority rating. Everyone starts with a priority rating that is their age. Doing this prioritizes older people over younger people. After that, people that are in specific priority groups receive a few hundred extra points. This  varies based on the priority of their group. For example, nurses might receive an extra 1000 points. This way, older nurses are prioritized over younger nurses and young nurses are prioritized over people who are not nurses. The following table illustrates this concept:

.Priority rating table
[cols="2,2,3", options="header"]
|===
|Age
|Job
|Priority rating

|60
|nurse
|1060

|33
|nurse
|1033

|71
|retired
|71

|52
|office worker
|52
|===


=== The OptaPlanner solver
At the core of OptaPlanner is the solver, the engine that takes the problem data set and overlays the planning constraints and configurations. The problem data set includes all of the information about the people, the vaccines, and the vaccination centers. The solver works through the various combinations of data and eventually determines an optimized appointment schedule with people assigned to vaccination appointments at a specific center.  The following illustration shows a schedule that the solver created:

image::QuickStart/VaccinationScheduler/vaccinationSchedulingValueProposal.png[]

=== Continuous planning
Continuous planning is the technique of managing one or more upcoming planning periods at the same time and repeating that process monthly, weekly, daily, hourly, or even more frequently. The planning window advances incrementally by a specified interval. The following illustration shows a two week planning window that is updated daily:

image::QuickStart/VaccinationScheduler/vaccinationSchedulingContinuousPlanning.png[]

The two week planning window is divided in half. The first week is in the published state and the second week is in the draft state.  People are assigned to appointments in both the published and draft parts of the planning window. However, only people in the published part of the planning window are notified of their appointments. The other appointments can still change easily in the next run. Doing this prevents the schedule from painting itself in a corner. For example, if a person who needs a second dose has a ready date of Monday and an ideal date of Wednesday, you don’t have to invite them for Monday if-and-only-if you can prove you can give them a draft appointment later in the week.

You can determine the size of the planning window but just be mindful of the size of the problem space. The problem space is all of the various components that go into creating the schedule. So, the more days you plan ahead the larger the problem space.

=== Pinned planning entities
If you are continuously planning on a daily basis, there will be appointments within the two week period that are already allocated to people. To ensure that appointments are not double-booked, you need to mark existing appointments as allocated by pinning them. Pinning is used to anchor one or more specific assignments and force OptaPlanner to schedule around those fixed assignments.  A pinned planning entity, such as an appointment, does not change during solving.

Whether an entity is pinned or not is determined by the appointment state. If you take a look at the previous image, you can see to the left of the image that an appointment can have five states : Open, Invited, Accepted, Rejected, or Rescheduled.

NOTE: You do not actually see these states directly in the quickstart demo code because the OptaPlanner engine is only interested in whether the appointment is pinned or not.

So as you can see from the image, you need to be able to plan around appointments that have already been scheduled. An appointment with the Invited or Accepted state is pinned. Appointments with the Open, Reschedule, and Rejected state are not pinned and are available for scheduling.

In this example,  when the solver runs it searches across the entire two week planning window in both the published and draft ranges. The solver considers any unpinned entities (appointments with the Open, Reschedule, or Rejected states) in addition to the unscheduled input data, to find the optimal solution. If the solver is run daily, you will see a new day added to the schedule before you run the solver, as shown in the middle image above. The third schedule shows the results of the solver.

Notice that the appointments on the new day have been assigned and Amy and Edna who were previously scheduled in the draft part of the planning window are now scheduled in the published part of the window. This was possible because Gus and Hugo requested a reschedule. This won’t cause any confusion because Amy and Edna were never notified about their draft dates. Now, because they have appointments in the published section of the planning window, they will be notified and asked to accept or reject their appointments, and their appointments are now pinned.

[id='spring-boot-ref-download-proc_{context}']

// tag::vaccination-scheduler-con[]
[id="vaccination-scheduler-download-proc_{context}"]

== Downloading and running the OptaPlanner vaccination appointment scheduler

Download the OptaPlanner vaccination appointment scheduler quickstart archive, start it in Quarkus development mode, and view the application in a browser. Quarkus development mode enables you to make changes and update your application while it is running.

.Prerequisites
//What are the prerequisites?

.Procedure
ifdef::OPTAPLANNER-COMM[]
. View the https://github.com/kiegroup/optaplanner-quickstarts[OptaPlanner Quickstarts] repository page in a browswer and download `quarkus-vaccination-scheduling`.
. Navigate to the `quarkus-vaccination-scheduling` directory.
endif::[]

ifdef::OPTAPLANNER-ENT[]
. Navigate to the https://access.redhat.com/jbossnetwork/restricted/listSoftware.html[Software Downloads] page in the Red Hat Customer Portal (login required), and select the product and version from the drop-down options:

* Product: {PRODUCT}
* Version: {PRODUCT_VERSION}
//Waiting for CR1 to see exactly how the quickstarts will be packaged.
. Download *{PRODUCT} {PRODUCT_VERSION} Reference Implementations* (`{PRODUCT_FILE}-reference-implementation.zip`).
. Download *{PRODUCT} {PRODUCT_VERSION} Maven Repository* (`{PRODUCT_FILE}-maven-repository.zip`).
. Extract the `{PRODUCT_FILE}-maven-repository.zip` file.
. Copy the contents of the `{PRODUCT_FILE}-maven-repository/maven-repository` subdirectory into the `~/.m2/repository` directory.
. Extract the `{PRODUCT_FILE}-reference-implementation.zip` file. This archive contains the quickstart files.
. Navigate to the `optaplanner-quickstarts-distribution-8.3.0.Final-redhat-00011/sources/quarkus-vaccination-scheduling` directory.
endif::[]

. Enter the following command to start the OptaPlanner vaccination appointment scheduler in development mode:
+
[source, shell]
----
$ mvn quarkus:dev
----

. To view the OptaPlanner vaccination appointment scheduler, enter the following URL in a web browser.
+
[source]
----
http://localhost:8080/
----

. To run the OptaPlanner vaccination appointment scheduler, click *Solve*.
. Make changes to the source code then press the F5 key to refresh your browser. Notice that the changes that you made are now available.


// tag::vaccination-scheduler-package-proc[]
[id="vaccination-scheduler-package-proc_{context}"]
== Package and run the application

When you have completed development work in `quarkus:dev` mode, run the application as a conventional jar file.

.Prerequisites
* You have downloaded the OptaPlanner vaccination appointment scheduler quickstart. For more information, see xref:vaccination-scheduler-download-proc_{context}[].

.Procedure
. Navigate to the `quarkus-vaccination-scheduling` directory.

. To compile the OptaPlanner vaccination appointment scheduler, enter the following command:
+
[source, shell]
----
$ mvn package
----

. To run the compiled OptaPlanner vaccination appointment scheduler, enter the following command:
+
[source, shell]
----
$ java -jar ./target/*-runner.jar
----
+
[NOTE]
====
To run the application on port 8081, add `-Dquarkus.http.port=8081` to the command.
====

. To start the OptaPlanner vaccination appointment scheduler, enter the following URL in a web browser.
+
[source]
----
http://localhost:8080/
----

ifdef::OPTAPLANNER-COMM[]
== Run the OptaPlanner vaccination appointment scheduler as a native executable
To take advantage of the small memory footprint and access speeds that Quarkus offers, compile the OptaPlanner vaccination appointment scheduler in Quarkus native mode.

.Prerequistes.

.Procedure

. Install GraalVM and the `native-image` tool. For information, see https://quarkus.io/guides/building-native-image#configuring-graalvm[Configuring GraalVMl] on the Quarkus website.
. Navigate to the `quarkus-vaccination-scheduling` directory.

. To compile the OptaPlanner vaccination appointment scheduler natively, enter the following command:
+
[source, shell]
----
$ mvn package -Dnative -DskipTests
----

. To run the native executable, enter the following command:
+
[source, shell]
----
$ ./target/*-runner
----

. To start the OptaPlanner vaccination appointment scheduler, enter the following URL in a web browser.
+
[source]
----
http://localhost:8080/
----

ifdef::OPTAPLANNER-COMM[]
[role="_additional-resources"]
== Additional resources
* https://www.youtube.com/watch?v=LTkoaBk-P6U[Vaccination appointment scheduling video]

endif::[]





ifdef::parent-context[:context: {parent-context}]
ifndef::parent-context[:!context:]
